name: CI → Scan → Build → Push → Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_scan_push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Docker login
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo:latest web

      - name: SonarQube scan
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          docker run --rm -v "$PWD:/src" -w /src sonarsource/sonar-scanner-cli \
            -Dsonar.projectBaseDir=/src \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN

      - name: Push image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo:latest

  deploy_minikube:
    needs: build_scan_push
    runs-on: self-hosted   # runner บนเครื่องคุณ
    steps:
      - uses: actions/checkout@v4

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          kubectl config current-context

      - name: Apply manifests
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl -n demo apply -f k8s/service.yaml
          kubectl -n demo set image deploy/nginx-demo nginx=${{ secrets.DOCKERHUB_USERNAME }}/nginx-demo:latest
          kubectl -n demo rollout status deploy/nginx-demo --timeout=180s

      - name: Smoke test
        run: |
          kubectl -n demo get po,svc
          which minikube && minikube service -n demo nginx-demo --url || true
